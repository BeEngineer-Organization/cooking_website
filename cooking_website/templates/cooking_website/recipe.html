{% extends 'cooking_website/base.html' %}
{% load static %}

{% block extra_style %}
<link rel="stylesheet" type="text/css" href="{% static 'cooking_website/css/recipe.css' %}">
{% endblock %}

{% block main %}
<div class="main__body">
    <div class="main__body-head">
        <div class="main__image-wrap">
            {% if object.image %}
            <img src="{{ object.image.url }}" alt="" class="main__image">
            {% else %}
            <i class="fa-solid fa-image alternative-image main__image"></i>
            {% endif %}
        </div>
        <div class="main__info-wrap">
            <h1 class="main__title">
                {{ object.title }}
            </h1>
            <div class="main__info">
                <div class="main__like">
                    {% if object.written_by == request.user %}
                    <a href="{% url 'cooking_website:recipe_update' object.pk %}" class="button">
                        編集
                    </a>
                    {% else %}
                    <button id="like_button" class="main__like-button">
                        {% if is_liked == True %}
                        <i class="fa-solid fa-heart fa-2x main__like-button--red"></i>
                        {% else %}
                        <i class="fa-regular fa-heart fa-2x"></i>
                        {% endif %}
                        <p id="like_count" class="main__like-count">
                            {{ like_count }}
                        </p>
                    </button>
                    {% endif %}
                </div>
                <a href="{% url 'cooking_website:user' object.written_by.pk %}" class="main__writer-wrap">
                    <div class="main__writer-image-wrap">
                        {% if object.image %}
                        <img src="{{ object.written_by.image.url }}" alt="" class="main__writer-image">
                        {% else %}
                        <i class="fa-solid fa-circle-user alternative-image main__writer-image"></i>
                        {% endif %}
                    </div>
                    <p class="main__writer-username">
                        {{ object.written_by.username }}
                    </p>
                </a>    
            </div>
            <p class="main__created-at">
                {{ object.created_at }}
            </p>        
        </div>
    </div>
    <div class="main__body-foot">
        <p class="main__description">
            {{ object.get_markdown_description_as_html | safe }}
        </p>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script type="text/javascript">
    document.getElementById("like_button").addEventListener("click", e => {
        e.preventDefault();
        const url = "{% url 'cooking_website:like_post' %}";
        fetch(url, {
            method: "POST",
            body: "recipe_pk={{ object.pk }}",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded; charset=utf-8",
                "X-CSRFToken": "{{ csrf_token }}",
                },
            }).then(response => {
                return response.json();
            }).then(response => {
                document.getElementById("like_count").textContent = response.like_count;
                follow_button = document.getElementById("like_button");
                follow_button.firstElementChild.classList.toggle("main__like-button--red")
                follow_button.firstElementChild.classList.toggle("fa-solid")
                follow_button.firstElementChild.classList.toggle("fa-regular")
            }).catch(error => {
                console.log(error);
            })
        });
</script>
{% endblock %}
